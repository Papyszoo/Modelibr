name: Code Quality (ESLint + Prettier)

on:
    push:
        branches: [main, develop]
        paths:
            - "src/frontend/**"
            - "src/asset-processor/**"
    pull_request:
        branches: [main, develop]
        paths:
            - "src/frontend/**"
            - "src/asset-processor/**"

jobs:
    frontend-quality:
        name: Frontend Code Quality
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: src/frontend

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: src/frontend/package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Run ESLint
              run: npm run lint

            - name: Check Prettier formatting
              run: npm run format:check

            - name: Run tests
              run: npm test

            - name: Build project
              run: npm run build

    asset-processor-quality:
        name: Asset Processor Code Quality
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: src/asset-processor

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: src/asset-processor/package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Run ESLint
              run: npm run lint

            - name: Check Prettier formatting
              run: npm run format:check

            - name: Run tests
              run: npm test

    # Combined status check for branch protection
    code-quality-status:
        name: Code Quality Status
        runs-on: ubuntu-latest
        needs: [frontend-quality, asset-processor-quality]
        if: always()

        steps:
            - name: Check all jobs succeeded
              if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
              run: |
                  echo "Code quality checks failed!"
                  exit 1

            - name: All checks passed
              run: |
                  echo "All code quality checks passed!"
