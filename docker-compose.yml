services:
    webapi:
        image: ${DOCKER_REGISTRY-}webapi
        build:
            context: .
            dockerfile: src/WebApi/Dockerfile
        container_name: webapi
        environment:
            - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
            - ASPNETCORE_HTTP_PORTS=${WEBAPI_HTTP_PORT}
            - ASPNETCORE_HTTPS_PORTS=${WEBAPI_HTTPS_PORT}
        ports:
            - "${WEBAPI_HTTP_PORT}"
            - "${WEBAPI_HTTPS_PORT}"
        volumes:
            - ${APPDATA}/Microsoft/UserSecrets:/home/app/.microsoft/usersecrets:ro
            - ${APPDATA}/Microsoft/UserSecrets:/root/.microsoft/usersecrets:ro
            - ${APPDATA}/ASP.NET/Https:/home/app/.aspnet/https:ro
            - ${APPDATA}/ASP.NET/Https:/root/.aspnet/https:ro
        depends_on:
            mssql:
                condition: service_healthy
        networks:
            - modelibr

    mssql:
        image: mcr.microsoft.com/mssql/server:2022-latest
        container_name: mssql
        environment:
            ACCEPT_EULA: "${ACCEPT_EULA}"
            SA_PASSWORD: "${SA_PASSWORD}"
            MSSQL_PID: "${MSSQL_PID}"
        ports:
            - "${MSSQL_PORT}:1433"
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P ${SA_PASSWORD} -Q 'SELECT 1' || exit 1",
                ]
            interval: 15s
            timeout: 5s
            retries: 10
            start_period: 20s
        volumes:
            - mssql-data:/var/opt/mssql
        networks:
            - modelibr

volumes:
    mssql-data:

networks:
  modelibr:
    driver: bridge
