services:
    webapi:
        image: ${DOCKER_REGISTRY-}webapi
        build:
            context: .
            dockerfile: src/WebApi/Dockerfile
            args:
                APP_UID: ${HOST_UID:-1000}
                APP_GID: ${HOST_GID:-1000}
        container_name: webapi
        environment:
            - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
            - ASPNETCORE_HTTP_PORTS=${WEBAPI_HTTP_PORT}
            - ASPNETCORE_HTTPS_PORTS=${WEBAPI_HTTPS_PORT}
            - UPLOAD_STORAGE_PATH=/var/lib/modelibr/uploads
        ports:
            - "${WEBAPI_HTTP_PORT}"
            - "${WEBAPI_HTTPS_PORT}"
        volumes:
            # Use platform-appropriate secret/cert paths; on macOS $HOME works (APPDATA is Windows-specific)
            - ${HOME}/.microsoft/usersecrets:/home/app/.microsoft/usersecrets:ro
            - ${HOME}/.aspnet/https:/home/app/.aspnet/https:ro
            - ./data/uploads:/var/lib/modelibr/uploads
        depends_on:
            mssql:
                condition: service_healthy
        networks:
            - modelibr
    frontend:
        image: ${DOCKER_REGISTRY-}frontend
        build:
            context: ./src/frontend
            dockerfile: Dockerfile
            target: production
        container_name: frontend
        ports:
            - "${FRONTEND_PORT:-3000}:80"
        networks:
            - modelibr
    mssql:
        image: mcr.microsoft.com/mssql/server:2022-latest
        container_name: mssql
        environment:
            ACCEPT_EULA: "${ACCEPT_EULA}"
            SA_PASSWORD: "${SA_PASSWORD}"
            MSSQL_PID: "${MSSQL_PID}"
        ports:
            - "${MSSQL_PORT}:1433"
        healthcheck:
            test: ["CMD-SHELL", "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P ${SA_PASSWORD} -Q 'SELECT 1' || exit 1"]
            interval: 15s
            timeout: 5s
            retries: 10
            start_period: 20s
        volumes:
            - mssql-data:/var/opt/mssql
        networks:
            - modelibr

volumes:
    mssql-data:

networks:
  modelibr:
    driver: bridge
