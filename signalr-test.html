<!DOCTYPE html>
<html>
<head>
    <title>SignalR Thumbnail Test</title>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
</head>
<body>
    <h1>SignalR Thumbnail Notification Test</h1>
    <div>
        <label>Model ID: <input type="number" id="modelId" value="1" /></label>
        <button onclick="connectToHub()">Connect</button>
        <button onclick="disconnectFromHub()">Disconnect</button>
    </div>
    <div>
        <h3>Test Notification</h3>
        <label>Status: <input type="text" id="status" value="Ready" /></label>
        <label>Thumbnail URL: <input type="text" id="thumbnailUrl" value="/models/1/thumbnail/file" /></label>
        <button onclick="sendTestNotification()">Send Test</button>
    </div>
    <div>
        <h3>Connection Status: <span id="connectionStatus">Disconnected</span></h3>
        <h3>Messages:</h3>
        <div id="messages"></div>
    </div>

    <script>
        let connection = null;
        let currentModelId = null;

        async function connectToHub() {
            const modelId = document.getElementById('modelId').value;
            if (!modelId) {
                alert('Please enter a model ID');
                return;
            }

            try {
                connection = new signalR.HubConnectionBuilder()
                    .withUrl('http://localhost:5009/thumbnailHub', {
                        withCredentials: false
                    })
                    .withAutomaticReconnect()
                    .build();

                connection.on('ThumbnailStatusChanged', (notification) => {
                    addMessage(`Received notification: ${JSON.stringify(notification, null, 2)}`);
                });

                connection.onclose(() => {
                    document.getElementById('connectionStatus').textContent = 'Disconnected';
                    addMessage('Connection closed');
                });

                connection.onreconnected(() => {
                    document.getElementById('connectionStatus').textContent = 'Connected';
                    addMessage('Reconnected');
                    if (currentModelId) {
                        connection.invoke('JoinModelGroup', currentModelId);
                    }
                });

                await connection.start();
                document.getElementById('connectionStatus').textContent = 'Connected';
                addMessage('Connected to SignalR hub');

                await connection.invoke('JoinModelGroup', modelId);
                currentModelId = modelId;
                addMessage(`Joined model group for model ${modelId}`);

            } catch (err) {
                addMessage(`Connection failed: ${err.message}`);
            }
        }

        async function disconnectFromHub() {
            if (connection) {
                if (currentModelId) {
                    await connection.invoke('LeaveModelGroup', currentModelId);
                }
                await connection.stop();
                connection = null;
                currentModelId = null;
                document.getElementById('connectionStatus').textContent = 'Disconnected';
                addMessage('Disconnected from SignalR hub');
            }
        }

        async function sendTestNotification() {
            const modelId = document.getElementById('modelId').value;
            const status = document.getElementById('status').value;
            const thumbnailUrl = document.getElementById('thumbnailUrl').value;

            try {
                const response = await fetch(`http://localhost:5009/api/test/thumbnail-complete/${modelId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status: status,
                        thumbnailUrl: thumbnailUrl
                    })
                });

                if (response.ok) {
                    addMessage('Test notification sent successfully');
                } else {
                    const error = await response.text();
                    addMessage(`Failed to send test notification: ${error}`);
                }
            } catch (err) {
                addMessage(`Error sending test notification: ${err.message}`);
            }
        }

        function addMessage(message) {
            const messages = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
        }
    </script>
</body>
</html>